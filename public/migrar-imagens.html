<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VIZZU - Migrar Imagens</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: #0a0a0a; color: #fff; padding: 20px; max-width: 800px; margin: 0 auto; }
    h1 { color: #f472b6; }
    .btn { background: linear-gradient(to right, #ec4899, #f97316); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: #333; }
    #log { background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 13px; white-space: pre-wrap; }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
    .warning { color: #fbbf24; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
    .stat { background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: bold; color: #f472b6; }
    .stat-label { font-size: 12px; color: #888; }
  </style>
</head>
<body>
  <h1>VIZZU - Migrar Imagens</h1>
  <p style="color: #888;">Comprimir imagens existentes no Supabase Storage para economizar bandwidth.</p>

  <div class="stats">
    <div class="stat"><div class="stat-value" id="total">0</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-value" id="compressed" style="color: #4ade80;">0</div><div class="stat-label">Comprimidas</div></div>
    <div class="stat"><div class="stat-value" id="skipped" style="color: #fbbf24;">0</div><div class="stat-label">Puladas</div></div>
    <div class="stat"><div class="stat-value" id="saved" style="color: #60a5fa;">0 MB</div><div class="stat-label">Economizado</div></div>
  </div>

  <div style="margin-bottom: 15px;">
    <button class="btn btn-secondary" id="btnSimular" onclick="runMigration(true)">Simular (Seguro)</button>
    <button class="btn" id="btnExecutar" onclick="runMigration(false)">Executar Migracao</button>
  </div>

  <div id="log">Clique em "Simular" para comecar...</div>

  <script type="module">
    const SUPABASE_URL = 'https://dbdqiqehuapcicejnzyd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiZHFpcWVodWFwY2ljZWpuenlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MjMxMjUsImV4cCI6MjA4NDA5OTEyNX0.LDcIu4VPBifzmy8z-lKkjqzgWo8-d8C0VjLl1XSWJiQ';

    let supabase, imageCompression, currentUserId;

    const logEl = document.getElementById('log');
    const totalEl = document.getElementById('total');
    const compressedEl = document.getElementById('compressed');
    const skippedEl = document.getElementById('skipped');
    const savedEl = document.getElementById('saved');

    function log(msg, type = 'info') {
      const line = document.createElement('div');
      line.className = type;
      line.textContent = msg;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStats(total, compressed, skipped, saved) {
      totalEl.textContent = total;
      compressedEl.textContent = compressed;
      skippedEl.textContent = skipped;
      savedEl.textContent = (saved / 1024 / 1024).toFixed(2) + ' MB';
    }

    async function init() {
      log('Carregando bibliotecas...');
      const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
      supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
      imageCompression = (await import('https://esm.sh/browser-image-compression@2.0.2')).default;

      // Verificar se usuario esta logado
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUserId = session.user.id;
        log('Logado como: ' + session.user.email, 'success');
      } else {
        log('AVISO: Voce precisa estar logado no app principal primeiro!', 'error');
        log('1. Abra o app Vizzu em outra aba', 'warning');
        log('2. Faca login normalmente', 'warning');
        log('3. Volte aqui e recarregue esta pagina', 'warning');
        document.getElementById('btnSimular').disabled = true;
        document.getElementById('btnExecutar').disabled = true;
        return;
      }

      log('Bibliotecas carregadas!', 'success');
    }

    window.runMigration = async function(dryRun) {
      if (!supabase) await init();

      const btnSimular = document.getElementById('btnSimular');
      const btnExecutar = document.getElementById('btnExecutar');
      btnSimular.disabled = true;
      btnExecutar.disabled = true;

      logEl.innerHTML = '';
      log(dryRun ? '=== MODO SIMULACAO (nao altera nada) ===' : '=== EXECUTANDO MIGRACAO ===', 'warning');

      try {
        log('Buscando imagens do usuario...');
        const { data: images, error } = await supabase
          .from('product_images')
          .select('id, storage_path, url, user_id')
          .eq('user_id', currentUserId);

        if (error) {
          log('Erro: ' + error.message, 'error');
          return;
        }

        log('Encontradas ' + images.length + ' imagens', 'success');

        let processed = 0, compressed = 0, skipped = 0, totalSaved = 0;
        updateStats(images.length, 0, 0, 0);

        for (const img of images) {
          processed++;

          if (!img.storage_path) {
            skipped++;
            updateStats(images.length, compressed, skipped, totalSaved);
            continue;
          }

          try {
            const { data: fileData, error: downloadError } = await supabase.storage
              .from('products')
              .download(img.storage_path);

            if (downloadError || !fileData) {
              log('[' + processed + '/' + images.length + '] ' + img.storage_path + ' - nao encontrada', 'warning');
              skipped++;
              updateStats(images.length, compressed, skipped, totalSaved);
              continue;
            }

            const originalSize = fileData.size;

            if (originalSize < 100000) {
              log('[' + processed + '/' + images.length + '] ' + img.storage_path + ' - ja pequena (' + (originalSize/1024).toFixed(0) + 'KB)', 'info');
              skipped++;
              updateStats(images.length, compressed, skipped, totalSaved);
              continue;
            }

            const file = new File([fileData], 'image.jpg', { type: fileData.type });
            const compressedBlob = await imageCompression(file, {
              maxSizeMB: 1,
              maxWidthOrHeight: 1920,
              useWebWorker: true,
              initialQuality: 0.85
            });

            const newSize = compressedBlob.size;
            const savings = originalSize - newSize;
            const savingsPercent = Math.round((1 - newSize / originalSize) * 100);

            if (savingsPercent < 10) {
              log('[' + processed + '/' + images.length + '] ' + img.storage_path + ' - ja otimizada', 'info');
              skipped++;
              updateStats(images.length, compressed, skipped, totalSaved);
              continue;
            }

            if (!dryRun) {
              const { error: uploadError } = await supabase.storage
                .from('products')
                .upload(img.storage_path, compressedBlob, { upsert: true });

              if (uploadError) {
                log('[' + processed + '/' + images.length + '] Erro upload: ' + uploadError.message, 'error');
                continue;
              }
            }

            totalSaved += savings;
            compressed++;
            log('[' + processed + '/' + images.length + '] ' + img.storage_path + ': ' + (originalSize/1024).toFixed(0) + 'KB -> ' + (newSize/1024).toFixed(0) + 'KB (' + savingsPercent + '% menor)', 'success');
            updateStats(images.length, compressed, skipped, totalSaved);

          } catch (err) {
            log('[' + processed + '/' + images.length + '] Erro: ' + err.message, 'error');
          }
        }

        log('===================================', 'info');
        log('CONCLUIDO!', 'success');
        log('Comprimidas: ' + compressed, 'success');
        log('Puladas: ' + skipped, 'warning');
        log('Economia: ' + (totalSaved/1024/1024).toFixed(2) + ' MB', 'success');
        if (dryRun) log('(Simulacao - nenhum dado foi alterado)', 'warning');

      } catch (err) {
        log('Erro fatal: ' + err.message, 'error');
      } finally {
        btnSimular.disabled = false;
        btnExecutar.disabled = false;
      }
    };

    init();
  </script>
</body>
</html>
