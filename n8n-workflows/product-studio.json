{
  "name": "Vizzu - Product Studio",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "vizzu/product-studio",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-001",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 0],
      "webhookId": "vizzu-product-studio"
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.first().json;\nconst body = raw.body || raw;\n\nconst startTime = Date.now();\n\nconst angles = body.angles || ['front'];\nif (!Array.isArray(angles) || angles.length === 0) {\n  throw new Error('Nenhum ângulo selecionado');\n}\n\nconst calculateCredits = (numAngles) => {\n  if (numAngles === 0) return 0;\n  if (numAngles <= 2) return 1;\n  return 1 + (numAngles - 2);\n};\n\nreturn {\n  productId: body.product_id,\n  userId: body.user_id,\n  imageId: body.image_id,\n  angles: angles,\n  anglesCount: angles.length,\n  creditsNeeded: calculateCredits(angles.length),\n  startTime: startTime\n};"
      },
      "id": "prep-001",
      "name": "Preparar Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "users",
        "limit": 1,
        "filterType": "string",
        "filterString": "={{ 'id=eq.' + $json.userId }}"
      },
      "id": "get-user-001",
      "name": "Buscar Usuario",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [440, 0],
      "credentials": {
        "supabaseApi": {
          "id": "qCwUIY0hdZVCpomG",
          "name": "Vizzu - Supabase"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{
            "id": "check-credits",
            "leftValue": "={{ $json.credits }}",
            "rightValue": "={{ $('Preparar Dados').item.json.creditsNeeded }}",
            "operator": { "type": "number", "operation": "gte" }
          }],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-credits-001",
      "name": "Tem Creditos?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [660, 0]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'insufficient_credits', message: 'Créditos insuficientes. Necessário: ' + $('Preparar Dados').item.json.creditsNeeded + ', Disponível: ' + $('Buscar Usuario').item.json.credits }) }}",
        "options": { "responseCode": 402 }
      },
      "id": "no-credits-001",
      "name": "Erro - Sem Creditos",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [880, 120]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "product_images",
        "limit": 1,
        "filterType": "string",
        "filterString": "={{ 'id=eq.' + $('Preparar Dados').item.json.imageId }}"
      },
      "id": "get-image-001",
      "name": "Buscar Imagem",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [880, -120],
      "credentials": {
        "supabaseApi": {
          "id": "qCwUIY0hdZVCpomG",
          "name": "Vizzu - Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "products",
        "limit": 1,
        "filterType": "string",
        "filterString": "={{ 'id=eq.' + $('Preparar Dados').item.json.productId }}"
      },
      "id": "get-product-001",
      "name": "Buscar Produto",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1100, -120],
      "credentials": {
        "supabaseApi": {
          "id": "qCwUIY0hdZVCpomG",
          "name": "Vizzu - Supabase"
        }
      }
    },
    {
      "parameters": {
        "tableId": "generations",
        "fieldsUi": {
          "fieldValues": [
            { "fieldId": "user_id", "fieldValue": "={{ $('Preparar Dados').item.json.userId }}" },
            { "fieldId": "product_id", "fieldValue": "={{ $('Preparar Dados').item.json.productId }}" },
            { "fieldId": "type", "fieldValue": "studio_ready" },
            { "fieldId": "input_image_url", "fieldValue": "={{ $('Buscar Imagem').item.json.url }}" },
            { "fieldId": "credits_used", "fieldValue": "={{ $('Preparar Dados').item.json.creditsNeeded }}" },
            { "fieldId": "status", "fieldValue": "processing" },
            { "fieldId": "started_at", "fieldValue": "={{ new Date().toISOString() }}" }
          ]
        }
      },
      "id": "create-gen-001",
      "name": "Criar Geracao",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1320, -120],
      "credentials": {
        "supabaseApi": {
          "id": "qCwUIY0hdZVCpomG",
          "name": "Vizzu - Supabase"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('Buscar Imagem').item.json.url }}",
        "options": {
          "response": { "response": { "responseFormat": "file" } }
        }
      },
      "id": "download-001",
      "name": "Download Imagem",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, -120]
    },
    {
      "parameters": {
        "jsCode": "// ETAPA 1: GERAR FOTO DE ESTÚDIO - GHOST MANNEQUIN\nconst binary = $input.first().binary;\nconst product = $('Buscar Produto').item.json;\n\nconst apiKey = 'AIzaSyAjxVPQvFgFqFxmI4_MlHB8jeTAxvuIPNM';\nconst model = 'gemini-2.0-flash-exp';\nconst endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;\n\nlet imageBase64 = null;\nlet imageMimeType = 'image/png';\n\nif (binary && binary.data) {\n  const buffer = await this.helpers.getBinaryDataBuffer(0, 'data');\n  imageBase64 = buffer.toString('base64');\n  imageMimeType = binary.data.mimeType || 'image/png';\n}\n\nif (!imageBase64) throw new Error('Nenhuma imagem encontrada');\n\n// Extrair informações do produto\nconst category = (product.category || 'produto').toLowerCase();\nconst color = product.color || '';\nconst fit = product.fit || '';\nconst description = product.description || '';\nconst attributes = product.attributes || {};\nconst caimento = attributes.caimento || fit || '';\n\n// === IDENTIFICAÇÃO DO TIPO DE PRODUTO ===\nconst clothingKeywords = ['camiseta', 'camisa', 'blusa', 'calça', 'shorts', 'vestido', 'saia', 'jaqueta', 'casaco', 'moletom', 'regata', 'bermuda', 'top', 'body', 'cropped', 'macacão', 'jardineira', 'conjunto', 'blazer', 'colete', 'suéter', 'cardigan', 'legging'];\nconst footwearKeywords = ['tênis', 'sapato', 'calçado', 'bota', 'sandália', 'chinelo', 'sapatilha', 'mocassim', 'oxford'];\nconst accessoryKeywords = ['bolsa', 'mochila', 'carteira', 'cinto', 'relógio', 'óculos', 'bijuteria', 'joia', 'colar', 'brinco', 'pulseira', 'anel', 'chapéu', 'boné', 'lenço', 'cachecol', 'gravata'];\n\nconst bottomKeywords = ['calça', 'shorts', 'bermuda', 'saia', 'legging'];\nconst topKeywords = ['camiseta', 'camisa', 'blusa', 'top', 'body', 'cropped', 'regata', 'jaqueta', 'casaco', 'moletom', 'blazer', 'colete', 'suéter', 'cardigan'];\nconst fullBodyKeywords = ['vestido', 'macacão', 'jardineira', 'conjunto'];\n\nconst isClothing = clothingKeywords.some(k => category.includes(k));\nconst isFootwear = footwearKeywords.some(k => category.includes(k));\nconst isAccessory = accessoryKeywords.some(k => category.includes(k));\nconst isBottomWear = bottomKeywords.some(k => category.includes(k));\nconst isTopWear = topKeywords.some(k => category.includes(k));\nconst isFullBody = fullBodyKeywords.some(k => category.includes(k));\n\n// === INSTRUÇÕES DE EXTRAÇÃO POR CATEGORIA ===\nlet extractionInstructions = '';\nif (isBottomWear) {\n  extractionInstructions = `EXTRACTION INSTRUCTIONS FOR BOTTOM WEAR:\n- Identify and extract ONLY the bottom garment (${category})\n- REMOVE: top garment, person, accessories, background\n- CUT at the waistline - show from waistband down\n- SHOW: waistband, pockets, legs, hem\n- EXCLUDE: any top garment, shoes, person's body`;\n} else if (isTopWear) {\n  extractionInstructions = `EXTRACTION INSTRUCTIONS FOR TOP WEAR:\n- Identify and extract ONLY the top garment (${category})\n- REMOVE: pants/skirt/shorts, person, accessories, background\n- SHOW: from neckline/collar to the hem of the garment\n- INCLUDE: neckline, sleeves, body of garment, hem\n- EXCLUDE: any bottom garment, person's body`;\n} else if (isFullBody) {\n  extractionInstructions = `EXTRACTION INSTRUCTIONS FOR FULL BODY GARMENT:\n- Extract the complete garment from neckline to hem\n- REMOVE: person, accessories, background\n- Show the entire piece as one complete garment`;\n} else if (isFootwear) {\n  extractionInstructions = `EXTRACTION INSTRUCTIONS FOR FOOTWEAR:\n- Identify and extract ONLY the footwear (${category})\n- REMOVE: person, clothing, background\n- Show only the shoe/sandal/boot\n- Side profile view preferred`;\n} else if (isAccessory) {\n  extractionInstructions = `EXTRACTION INSTRUCTIONS FOR ACCESSORY:\n- Identify and extract ONLY this specific accessory (${category})\n- REMOVE: person, clothing, other accessories, background`;\n} else {\n  extractionInstructions = `EXTRACTION INSTRUCTIONS:\n- Identify and extract the product (${category})\n- REMOVE: person, background, other items\n- Show only the product itself`;\n}\n\n// === INSTRUÇÕES DE FIT/CAIMENTO ===\nlet fitInstructions = '';\nif (caimento) {\n  const fitLower = caimento.toLowerCase();\n  if (fitLower.includes('oversized') || fitLower.includes('over') || fitLower.includes('amplo') || fitLower.includes('solto')) {\n    fitInstructions = 'FIT: OVERSIZED - Wide, relaxed, loose silhouette. Structured but roomy.';\n  } else if (fitLower.includes('slim') || fitLower.includes('skinny') || fitLower.includes('ajustado') || fitLower.includes('justo')) {\n    fitInstructions = 'FIT: SLIM/SKINNY - Fitted, close to body, streamlined silhouette.';\n  } else if (fitLower.includes('regular') || fitLower.includes('classic')) {\n    fitInstructions = 'FIT: REGULAR - Balanced, standard proportions.';\n  } else if (fitLower.includes('wide') || fitLower.includes('pantalona') || fitLower.includes('flare')) {\n    fitInstructions = 'FIT: WIDE LEG - Preserve the wide leg opening, ample cut or flare.';\n  } else {\n    fitInstructions = `FIT: ${caimento} - Preserve exact fit/proportions from original image.`;\n  }\n} else {\n  fitInstructions = 'FIT: AUTO - Preserve exact fit/proportions from original image.';\n}\n\n// === INSTRUÇÕES DE APRESENTAÇÃO ===\nlet presentationInstructions = '';\nif (isBottomWear) {\n  presentationInstructions = `PRESENTATION FOR PANTS/SHORTS/SKIRTS:\n- Ghost mannequin style: as if worn by invisible legs\n- Show natural drape and leg shape\n- Waistband at top, fully visible\n- Both legs visible and well-formed\n- Maintain exact cut: wide leg stays wide, slim stays slim\n- Hem at bottom, clean and even`;\n} else if (isTopWear) {\n  presentationInstructions = `PRESENTATION FOR TOPS/SHIRTS/BLOUSES:\n- Ghost mannequin style: as if worn by invisible torso\n- Shoulders filled out, neckline open\n- Sleeves hanging naturally with arm shape\n- Body has volume as if on a torso\n- NOT flattened, NOT wrinkled`;\n} else if (isFootwear) {\n  presentationInstructions = `PRESENTATION FOR FOOTWEAR:\n- Side profile view\n- Natural resting position\n- Show complete shoe from heel to toe`;\n}\n\n// === CONSTRUIR PROMPT COMPLETO ===\nconst prompt = `IMPORTANT: You are EDITING the provided image, NOT generating a new one. The product in the output MUST be the EXACT SAME product from the input image - same design, same colors, same details. Do NOT create a different product.\n\nTASK: Transform THIS SPECIFIC product image into a professional e-commerce studio photograph.\n\nPRODUCT: ${category}\nCOLOR: ${color || 'as shown'}\n${description ? 'DESCRIPTION: ' + description : ''}\n\n${extractionInstructions}\n\n${fitInstructions}\n\n${presentationInstructions}\n\nCOMPOSITION:\n- Perfectly centered extracted product\n- Minimum 20% padding on all sides\n- Vertical format (4:5 or 9:16 crop compatible)\n- Product fills 50-60% of frame height\n\nBACKGROUND:\n- SOLID, FLAT, UNIFORM light gray (#EDEDED to #F2F2F2)\n- NO gradients, NO shadows, completely flat\n- Nike/New Balance product photo style\n\nLIGHTING:\n- Soft, even, diffused studio lighting\n- No harsh shadows\n- Product \"floats\" cleanly on gray background\n\nPRODUCT INTEGRITY:\n- PRESERVE exact original colors\n- PRESERVE all details: stitching, buttons, pockets\n- PRESERVE fabric texture\n- PRESERVE the fit and proportions\n\nSTRICT RULES:\n- NO humans, faces, hands, visible skin\n- NO other clothing items\n- ONLY the specific product (${category})\n- NO visible mannequin\n- NO modifications to original product colors/patterns\n\nNEGATIVE (AVOID): human, person, model, face, hands, skin, body, visible legs, visible arms, other clothes, multiple items, full outfit, wrinkled, crumpled, flat lay, shapeless, visible mannequin, display stand, gradient background, shadow on background, white background, distorted, wrong colors, blurry, low quality, watermark\n\nOUTPUT: Vertical 9:16 format, professional e-commerce photo showing ONLY the ${category}, ghost mannequin style, on flat gray background.\n\nCRITICAL REMINDER: The output MUST show the EXACT SAME product from the input image. Same colors, same design, same details. You are EDITING, not creating.`;\n\nconst payload = {\n  contents: [{ role: \"user\", parts: [\n    { inline_data: { mime_type: imageMimeType, data: imageBase64 } },\n    { text: prompt }\n  ]}],\n  generationConfig: { responseModalities: [\"TEXT\", \"IMAGE\"], temperature: 0.3 },\n  safetySettings: [\n    { category: \"HARM_CATEGORY_HARASSMENT\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_HATE_SPEECH\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_SEXUALLY_EXPLICIT\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_DANGEROUS_CONTENT\", threshold: \"BLOCK_NONE\" }\n  ]\n};\n\nconst response = await this.helpers.httpRequest({\n  method: 'POST', url: endpoint,\n  headers: { 'Content-Type': 'application/json' },\n  body: payload, json: true, timeout: 180000\n});\n\nlet studioImageBase64 = null;\nif (response.candidates?.[0]?.content?.parts) {\n  for (const part of response.candidates[0].content.parts) {\n    if (part.inlineData?.data) studioImageBase64 = part.inlineData.data;\n  }\n}\n\nif (!studioImageBase64) throw new Error('Gemini não retornou foto de estúdio');\n\nreturn [{\n  json: {\n    studioImageBase64: studioImageBase64,\n    generationId: $('Criar Geracao').item.json.id,\n    product: product,\n    productType: { isClothing, isFootwear, isAccessory, isBottomWear, isTopWear, isFullBody }\n  },\n  binary: {\n    studioImage: { data: studioImageBase64, mimeType: 'image/png', fileName: 'studio.png' }\n  }\n}];"
      },
      "id": "remove-bg-001",
      "name": "Gerar Foto Estudio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, -120]
    },
    {
      "parameters": {
        "jsCode": "function generateUUID() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {\n    const r = Math.random() * 16 | 0;\n    return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);\n  });\n}\n\nconst input = $input.first();\nconst userId = $('Preparar Dados').item.json.userId;\nconst productId = $('Preparar Dados').item.json.productId;\nconst studioImageId = generateUUID();\n\nconst storagePath = `${userId}/${productId}/studio_base_${studioImageId}.png`;\nconst publicUrl = `https://dbdqiqehuapcicejnzyd.supabase.co/storage/v1/object/public/products/${storagePath}`;\n\nreturn [{\n  json: {\n    ...input.json,\n    studioImageId,\n    studioStoragePath: storagePath,\n    studioPublicUrl: publicUrl\n  },\n  binary: input.binary\n}];"
      },
      "id": "gen-clean-path-001",
      "name": "Path Imagem Limpa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1980, -120]
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "products",
        "fileName": "={{ $json.studioStoragePath }}",
        "binaryPropertyName": "studioImage",
        "additionalFields": {}
      },
      "id": "upload-clean-001",
      "name": "Upload Imagem Limpa",
      "type": "n8n-nodes-base.s3",
      "typeVersion": 1,
      "position": [2200, -120],
      "credentials": {
        "s3": {
          "id": "IANNuMl4gOF84BAm",
          "name": "Vizzu S3 account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Criar um item para cada ângulo, passando o base64 via JSON\n// IMPORTANTE: Se o ângulo for 'front', usamos a foto de estúdio diretamente (já gerada na Etapa 1)\nconst input = $input.first().json;\nconst angles = $('Preparar Dados').item.json.angles;\n\nconst items = angles.map((angle, index) => ({\n  json: {\n    currentAngle: angle,\n    angleIndex: index,\n    totalAngles: angles.length,\n    studioImageBase64: input.studioImageBase64,\n    studioPublicUrl: input.studioPublicUrl,\n    generationId: input.generationId,\n    product: input.product,\n    productType: input.productType,\n    isFrontAngle: angle === 'front'\n  },\n  pairedItem: { item: 0 }\n}));\n\nreturn items;"
      },
      "id": "prep-loop-001",
      "name": "Preparar Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2420, -120]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst angle = input.currentAngle;\nconst product = input.product;\nconst productType = input.productType || {};\n\n// Se for frontal, não precisa gerar - passa direto\nif (input.isFrontAngle) {\n  return [{ json: { ...input, prompt: null, skipGeneration: true }, pairedItem: { item: 0 } }];\n}\n\nconst category = (product.category || 'produto').toLowerCase();\nconst color = product.color || '';\nconst fit = product.fit || '';\nconst description = product.description || '';\nconst attributes = product.attributes || {};\nconst caimento = attributes.caimento || fit || '';\n\n// Usar productType da Etapa 1 ou recalcular\nconst { isClothing, isFootwear, isAccessory, isBottomWear, isTopWear, isFullBody } = productType;\n\n// Instruções de fit\nlet fitInstructions = '';\nif (caimento) {\n  const fitLower = caimento.toLowerCase();\n  if (fitLower.includes('oversized') || fitLower.includes('over') || fitLower.includes('amplo')) {\n    fitInstructions = 'FIT: OVERSIZED - Wide, relaxed silhouette.';\n  } else if (fitLower.includes('slim') || fitLower.includes('skinny') || fitLower.includes('justo')) {\n    fitInstructions = 'FIT: SLIM - Fitted, close to body.';\n  } else if (fitLower.includes('wide') || fitLower.includes('pantalona') || fitLower.includes('flare')) {\n    fitInstructions = 'FIT: WIDE - Preserve wide leg opening.';\n  } else {\n    fitInstructions = `FIT: ${caimento} - Preserve exact fit.`;\n  }\n}\n\n// Construir prompt específico por ângulo\nlet fullPrompt = '';\n\nconst baseInfo = `PRODUCT: ${category}\\nCOLOR: ${color || 'as shown'}\\n${fitInstructions}\\n\\nBACKGROUND: SOLID light gray (#EDEDED to #F2F2F2), NO gradients, NO shadows\\nLIGHTING: Soft, even, diffused studio lighting\\n\\nSTRICT RULES:\\n- NO humans, faces, hands, visible skin\\n- NO visible mannequin\\n- ONLY the ${category}\\n- PRESERVE exact original colors and proportions\\n\\nNEGATIVE: human, person, model, face, hands, skin, visible mannequin, gradient background, shadow, distorted, wrong colors`;\n\nswitch (angle) {\n  case 'back':\n    if (isBottomWear) {\n      fullPrompt = `Generate BACK VIEW of this ${category} based on the front view.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Show back of the garment (${category})\\n- Ghost mannequin style: as if worn by invisible legs\\n- Show back pockets, seams, waistband from behind\\n- Maintain EXACT same fit/silhouette as front\\n- Waistband visible at top, hem at bottom\\n\\nOUTPUT: Professional e-commerce BACK VIEW, ghost mannequin style, vertical 9:16 format.`;\n    } else if (isTopWear) {\n      fullPrompt = `Generate BACK VIEW of this ${category} based on the front view.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Show back of the garment\\n- Ghost mannequin style: as if worn by invisible torso\\n- Show back details, seams, any back design\\n- Shoulders filled, sleeves hanging naturally\\n- Maintain EXACT same fit/silhouette as front\\n\\nOUTPUT: Professional e-commerce BACK VIEW, ghost mannequin style, vertical 9:16 format.`;\n    } else {\n      fullPrompt = `Generate BACK VIEW of this ${category}.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Show back of the product\\n- Ghost mannequin style if clothing\\n- Preserve all details and proportions\\n\\nOUTPUT: Professional e-commerce BACK VIEW, vertical 9:16 format.`;\n    }\n    break;\n  case 'side-left':\n    fullPrompt = `Generate LEFT SIDE VIEW of this ${category}.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Show product from LEFT side profile\\n- Ghost mannequin style: show silhouette/profile\\n- Preserve the exact fit and proportions\\n- Show how the garment drapes from the side\\n\\nOUTPUT: Professional e-commerce LEFT SIDE VIEW, ghost mannequin style, vertical 9:16 format.`;\n    break;\n  case 'side-right':\n    fullPrompt = `Generate RIGHT SIDE VIEW of this ${category}.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Show product from RIGHT side profile\\n- Ghost mannequin style: show silhouette/profile\\n- Preserve the exact fit and proportions\\n- Show how the garment drapes from the side\\n\\nOUTPUT: Professional e-commerce RIGHT SIDE VIEW, ghost mannequin style, vertical 9:16 format.`;\n    break;\n  case '45-left':\n    fullPrompt = `Generate 45-DEGREE LEFT ANGLE VIEW of this ${category}.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Show product at 45 degrees from front-left\\n- Ghost mannequin style\\n- Show both front and left side aspects\\n- Preserve exact fit and proportions\\n\\nOUTPUT: Professional e-commerce 45-DEGREE LEFT VIEW, ghost mannequin style, vertical 9:16 format.`;\n    break;\n  case '45-right':\n    fullPrompt = `Generate 45-DEGREE RIGHT ANGLE VIEW of this ${category}.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Show product at 45 degrees from front-right\\n- Ghost mannequin style\\n- Show both front and right side aspects\\n- Preserve exact fit and proportions\\n\\nOUTPUT: Professional e-commerce 45-DEGREE RIGHT VIEW, ghost mannequin style, vertical 9:16 format.`;\n    break;\n  case 'detail':\n    fullPrompt = `Generate DETAIL/CLOSE-UP photo of this ${category}.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Focus on texture, stitching, fabric quality\\n- Show material details, buttons, seams, prints clearly\\n- Professional macro photography style\\n- Highlight craftsmanship and quality\\n\\nOUTPUT: Professional DETAIL/CLOSE-UP photo, vertical 9:16 format.`;\n    break;\n  case 'top':\n    fullPrompt = `Generate TOP VIEW/FLAT LAY of this ${category}.\\n\\n${baseInfo}\\n\\nSPECIFIC INSTRUCTIONS:\\n- Bird's eye view from directly above\\n- Flat lay style, neatly arranged\\n- Show complete garment shape\\n- Preserve exact colors and proportions\\n\\nOUTPUT: Professional TOP VIEW/FLAT LAY photo, vertical 9:16 format.`;\n    break;\n  default:\n    fullPrompt = `Generate ${angle.toUpperCase()} VIEW of this ${category}.\\n\\n${baseInfo}\\n\\nOUTPUT: Professional e-commerce photo, ghost mannequin style, vertical 9:16 format.`;\n}\n\nreturn [{ json: { ...input, prompt: fullPrompt, skipGeneration: false }, pairedItem: { item: 0 } }];"
      },
      "id": "build-prompt-001",
      "name": "Construir Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2640, -120]
    },
    {
      "parameters": {
        "jsCode": "// GERAR ÂNGULO - Lê base64 do JSON\nconst input = $input.first().json;\nconst angle = input.currentAngle;\nconst imageBase64 = input.studioImageBase64;\n\n// Se for frontal, usar a foto de estúdio diretamente (já gerada na Etapa 1)\nif (input.skipGeneration || input.isFrontAngle) {\n  return [{\n    json: { ...input, generatedBase64: imageBase64 },\n    binary: {\n      generatedAngle: { data: imageBase64, mimeType: 'image/png', fileName: `studio_${angle}.png` }\n    },\n    pairedItem: { item: 0 }\n  }];\n}\n\nconst prompt = input.prompt;\nif (!imageBase64) throw new Error('Imagem de estúdio não encontrada no JSON');\n\nconst apiKey = 'AIzaSyAjxVPQvFgFqFxmI4_MlHB8jeTAxvuIPNM';\nconst model = 'gemini-2.0-flash-exp';\nconst endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;\n\nconst payload = {\n  contents: [{ role: \"user\", parts: [\n    { inline_data: { mime_type: 'image/png', data: imageBase64 } },\n    { text: prompt }\n  ]}],\n  generationConfig: { responseModalities: [\"TEXT\", \"IMAGE\"], temperature: 0.8 },\n  safetySettings: [\n    { category: \"HARM_CATEGORY_HARASSMENT\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_HATE_SPEECH\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_SEXUALLY_EXPLICIT\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_DANGEROUS_CONTENT\", threshold: \"BLOCK_NONE\" }\n  ]\n};\n\nconst response = await this.helpers.httpRequest({\n  method: 'POST', url: endpoint,\n  headers: { 'Content-Type': 'application/json' },\n  body: payload, json: true, timeout: 180000\n});\n\nlet generatedBase64 = null;\nif (response.candidates?.[0]?.content?.parts) {\n  for (const part of response.candidates[0].content.parts) {\n    if (part.inlineData?.data) generatedBase64 = part.inlineData.data;\n  }\n}\n\nif (!generatedBase64) throw new Error('Gemini não retornou imagem para: ' + angle);\n\nreturn [{\n  json: { ...input, generatedBase64 },\n  binary: {\n    generatedAngle: { data: generatedBase64, mimeType: 'image/png', fileName: `studio_${angle}.png` }\n  },\n  pairedItem: { item: 0 }\n}];"
      },
      "id": "gen-angle-001",
      "name": "Gerar Angulo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2860, -120]
    },
    {
      "parameters": {
        "jsCode": "function generateUUID() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {\n    const r = Math.random() * 16 | 0;\n    return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);\n  });\n}\n\nconst input = $input.first();\nconst angle = input.json.currentAngle;\nconst userId = $('Preparar Dados').item.json.userId;\nconst productId = $('Preparar Dados').item.json.productId;\nconst angleImageId = generateUUID();\n\nconst storagePath = `${userId}/${productId}/studio_${angle}_${angleImageId}.png`;\nconst publicUrl = `https://dbdqiqehuapcicejnzyd.supabase.co/storage/v1/object/public/products/${storagePath}`;\n\nreturn [{\n  json: { ...input.json, angleImageId, angleStoragePath: storagePath, anglePublicUrl: publicUrl },\n  binary: input.binary\n}];"
      },
      "id": "gen-angle-path-001",
      "name": "Path Angulo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3080, -120]
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "products",
        "fileName": "={{ $json.angleStoragePath }}",
        "binaryPropertyName": "generatedAngle",
        "additionalFields": {}
      },
      "id": "upload-angle-001",
      "name": "Upload Angulo",
      "type": "n8n-nodes-base.s3",
      "typeVersion": 1,
      "position": [3300, -120],
      "credentials": {
        "s3": {
          "id": "IANNuMl4gOF84BAm",
          "name": "Vizzu S3 account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "product_images",
        "fieldsUi": {
          "fieldValues": [
            { "fieldId": "product_id", "fieldValue": "={{ $('Preparar Dados').item.json.productId }}" },
            { "fieldId": "user_id", "fieldValue": "={{ $('Preparar Dados').item.json.userId }}" },
            { "fieldId": "type", "fieldValue": "studio_ready" },
            { "fieldId": "angle", "fieldValue": "={{ $json.currentAngle }}" },
            { "fieldId": "storage_path", "fieldValue": "={{ $json.angleStoragePath }}" },
            { "fieldId": "url", "fieldValue": "={{ $json.anglePublicUrl }}" },
            { "fieldId": "generation_id", "fieldValue": "={{ $json.generationId }}" },
            { "fieldId": "file_name", "fieldValue": "={{ 'studio_' + $json.currentAngle + '.png' }}" },
            { "fieldId": "mime_type", "fieldValue": "image/png" },
            { "fieldId": "is_primary", "fieldValue": "false" }
          ]
        }
      },
      "id": "insert-angle-001",
      "name": "Inserir Imagem",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [3520, -120],
      "credentials": {
        "supabaseApi": {
          "id": "qCwUIY0hdZVCpomG",
          "name": "Vizzu - Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst generations = items.map(item => ({\n  angle: item.json.currentAngle,\n  image_url: item.json.anglePublicUrl,\n  image_id: item.json.angleImageId\n}));\n\nreturn [{\n  json: {\n    generationId: items[0].json.generationId,\n    studioImageUrl: items[0].json.studioPublicUrl,\n    generations,\n    totalAngles: items.length\n  }\n}];"
      },
      "id": "aggregate-001",
      "name": "Agregar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3740, -120]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "generations",
        "filters": {
          "conditions": [{ "keyName": "id", "condition": "eq", "keyValue": "={{ $json.generationId }}" }]
        },
        "fieldsUi": {
          "fieldValues": [
            { "fieldId": "studio_image_url", "fieldValue": "={{ $json.studioImageUrl }}" },
            { "fieldId": "output_urls", "fieldValue": "={{ JSON.stringify($json.generations) }}" },
            { "fieldId": "status", "fieldValue": "completed" },
            { "fieldId": "completed_at", "fieldValue": "={{ new Date().toISOString() }}" },
            { "fieldId": "processing_time_ms", "fieldValue": "={{ Date.now() - $('Preparar Dados').item.json.startTime }}" }
          ]
        }
      },
      "id": "update-gen-001",
      "name": "Atualizar Geracao",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [3960, -120],
      "credentials": {
        "supabaseApi": {
          "id": "qCwUIY0hdZVCpomG",
          "name": "Vizzu - Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "users",
        "filters": {
          "conditions": [{ "keyName": "id", "condition": "eq", "keyValue": "={{ $('Preparar Dados').item.json.userId }}" }]
        },
        "fieldsUi": {
          "fieldValues": [
            { "fieldId": "credits", "fieldValue": "={{ $('Buscar Usuario').item.json.credits - $('Preparar Dados').item.json.creditsNeeded }}" },
            { "fieldId": "credits_used_this_month", "fieldValue": "={{ ($('Buscar Usuario').item.json.credits_used_this_month || 0) + $('Preparar Dados').item.json.creditsNeeded }}" }
          ]
        }
      },
      "id": "debit-001",
      "name": "Debitar",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [4180, -120],
      "credentials": {
        "supabaseApi": {
          "id": "qCwUIY0hdZVCpomG",
          "name": "Vizzu - Supabase"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: true,\n  studio_image_url: $('Agregar').item.json.studioImageUrl,\n  generations: $('Agregar').item.json.generations,\n  generation_id: $('Agregar').item.json.generationId,\n  credits_used: $('Preparar Dados').item.json.creditsNeeded,\n  credits_remaining: $('Buscar Usuario').item.json.credits - $('Preparar Dados').item.json.creditsNeeded\n}) }}",
        "options": { "responseCode": 200 }
      },
      "id": "success-001",
      "name": "Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [4400, -120]
    }
  ],
  "connections": {
    "Webhook": { "main": [[{ "node": "Preparar Dados", "type": "main", "index": 0 }]] },
    "Preparar Dados": { "main": [[{ "node": "Buscar Usuario", "type": "main", "index": 0 }]] },
    "Buscar Usuario": { "main": [[{ "node": "Tem Creditos?", "type": "main", "index": 0 }]] },
    "Tem Creditos?": { "main": [
      [{ "node": "Buscar Imagem", "type": "main", "index": 0 }],
      [{ "node": "Erro - Sem Creditos", "type": "main", "index": 0 }]
    ]},
    "Buscar Imagem": { "main": [[{ "node": "Buscar Produto", "type": "main", "index": 0 }]] },
    "Buscar Produto": { "main": [[{ "node": "Criar Geracao", "type": "main", "index": 0 }]] },
    "Criar Geracao": { "main": [[{ "node": "Download Imagem", "type": "main", "index": 0 }]] },
    "Download Imagem": { "main": [[{ "node": "Gerar Foto Estudio", "type": "main", "index": 0 }]] },
    "Gerar Foto Estudio": { "main": [[{ "node": "Path Imagem Limpa", "type": "main", "index": 0 }]] },
    "Path Imagem Limpa": { "main": [[{ "node": "Upload Imagem Limpa", "type": "main", "index": 0 }]] },
    "Upload Imagem Limpa": { "main": [[{ "node": "Preparar Loop", "type": "main", "index": 0 }]] },
    "Preparar Loop": { "main": [[{ "node": "Construir Prompt", "type": "main", "index": 0 }]] },
    "Construir Prompt": { "main": [[{ "node": "Gerar Angulo", "type": "main", "index": 0 }]] },
    "Gerar Angulo": { "main": [[{ "node": "Path Angulo", "type": "main", "index": 0 }]] },
    "Path Angulo": { "main": [[{ "node": "Upload Angulo", "type": "main", "index": 0 }]] },
    "Upload Angulo": { "main": [[{ "node": "Inserir Imagem", "type": "main", "index": 0 }]] },
    "Inserir Imagem": { "main": [[{ "node": "Agregar", "type": "main", "index": 0 }]] },
    "Agregar": { "main": [[{ "node": "Atualizar Geracao", "type": "main", "index": 0 }]] },
    "Atualizar Geracao": { "main": [[{ "node": "Debitar", "type": "main", "index": 0 }]] },
    "Debitar": { "main": [[{ "node": "Sucesso", "type": "main", "index": 0 }]] }
  },
  "pinData": {},
  "meta": { "instanceId": "f5408b2397ec961558c2d1645ab20174aeb712fe37b2f614021d4bd5b8702549" }
}
