# Sessao 02/02/2026 (noite) — Resumo e Proximos Passos

## O que fizemos hoje

### 1. Configuracao do N8N (EasyPanel)
- Adicionamos variaveis de ambiente nos containers **worker** e **webhook**:
  - `SUPABASE_URL`, `SUPABASE_SERVICE_KEY`, `STRIPE_SECRET_KEY`, `GEMINI_API_KEY`, `EVOLUTION_API_URL`, `EVOLUTION_API_KEY`
- Adicionamos `N8N_BLOCK_ENV_ACCESS_IN_NODE=false` (nao funcionou — ver aprendizados)

### 2. Correcao de funcoes SQL no Supabase
- **`deduct_credits`**: estava referenciando tabela `users.credits` que nao existe. Corrigido para usar `user_credits.balance`
- **`add_credits`**: mesmo problema. Corrigido da mesma forma.
- Ambas as funcoes agora usam `FOR UPDATE` (lock de linha) para evitar race conditions.

### 3. Workflows corrigidos e testados

| Workflow | Status | Testado? |
|---|---|---|
| **02 - Use Credits** | Corrigido e funcionando | Sim - descontou 1 credito com sucesso |
| **07 - Create Checkout** | Corrigido e funcionando | Sim - criou sessao Stripe, pagamento completou |
| **08 - Change Plan** | Corrigido (arquivo pronto) | Nao testado (precisa de assinatura ativa - agora temos uma) |
| **09 - Stripe Webhook** | Corrigido e funcionando | Sim - recebeu evento do Stripe, atualizou plano para basic, adicionou 40 creditos |

### 4. Configuracao do Stripe
- Webhook configurado no Stripe Dashboard apontando para `https://n8nwebhook.brainia.store/webhook/vizzu/stripe-webhook`
- Eventos: `checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.payment_failed`
- Pagamento teste realizado com sucesso (plano basic mensal, R$127)

### 5. Estado atual do usuario de teste

**User**: `2e086a20-870f-4b54-a049-804f40c1313f` (felipelima.pro@gmail.com)
- **Plano**: basic (era free)
- **Saldo**: 44 creditos (5 boas-vindas - 1 teste + 40 do plano)
- **Stripe Customer**: `cus_TuP7H0exg7Dh5n`
- **Stripe Subscription**: `sub_1SwaV5Es8Fn8SiVw0zurxhQp`

---

## Erros encontrados e como resolvemos

### Erro 1: `$env` bloqueado no N8N
- **Problema**: N8N 2.4.4 bloqueia `$env` em nodes por padrao (`N8N_BLOCK_ENV_ACCESS_IN_NODE`)
- **Tentativa**: Setar `N8N_BLOCK_ENV_ACCESS_IN_NODE=false` — nao funcionou mesmo apos reiniciar
- **Solucao**: Hardcodar URLs e chaves direto nos nodes dos workflows
- **Regra**: NUNCA usar `$env` nos workflows

### Erro 2: `fetch` nao existe no Code Node
- **Problema**: Tentamos usar `fetch()` dentro de um Code node para chamar API do Stripe
- **Erro**: `ReferenceError: fetch is not defined`
- **Solucao**: Usar nodes HTTP Request separados para chamadas HTTP. Code nodes so fazem logica/transformacao.

### Erro 3: Body enviado como string em vez de JSON
- **Problema**: Nodes HTTP usavam `specifyBody: "string"` com `body` — o Supabase interpretava o JSON como nome de coluna
- **Erro**: `PGRST204 - Could not find column`
- **Solucao**: Trocar para `specifyBody: "json"` com `jsonBody`

### Erro 4: Tipo `renewal` nao existe em credit_transactions
- **Problema**: A tabela `credit_transactions` tem constraint que so aceita: `purchase`, `usage`, `bonus`, `refund`, `plan_reset`
- **Erro**: `23514 - violates check constraint "credit_transactions_type_check"`
- **Solucao**: Trocar `renewal` por `plan_reset`

### Erro 5: Funcoes SQL referenciavam tabela errada
- **Problema**: `deduct_credits` e `add_credits` referenciavam `users.credits` que nao existe
- **Solucao**: Reescrevemos ambas para usar `user_credits.balance`

### Erro 6: URL de retorno errada no checkout
- **Problema**: Redirect apos pagamento ia para `app.vizzu.com.br` (nao existe)
- **Solucao**: Trocado para `vizzu.pro` no workflow 07

---

## Proximos passos para amanha

### Prioridade 1: Reimportar workflow 07 com URL corrigida
O workflow 07 (Create Checkout) foi corrigido para usar `vizzu.pro` em vez de `app.vizzu.com.br`. Precisa reimportar no N8N.

**Sobre as URLs do app:**
- **Agora**: o app roda em `https://vizzu.pro`
- **Futuro**: quando a pagina de vendas for criada, ela fica em `vizzu.pro` e o app muda para `https://app.vizzu.pro`
- Quando essa mudanca acontecer, atualizar as `success_url` e `cancel_url` no workflow 07 de `vizzu.pro` para `app.vizzu.pro`

### Prioridade 2: Reimportar workflow 08 (Change Plan) corrigido
Ja esta pronto em `n8n-workflows/08-change-plan.json`. Importar no N8N e testar:
- Agora que temos assinatura ativa, podemos testar mudanca de plano
- Body de teste:
```json
{
  "user_id": "2e086a20-870f-4b54-a049-804f40c1313f",
  "new_plan_id": "pro",
  "billing_period": "monthly"
}
```

### Prioridade 3: Corrigir workflows restantes (01, 03, 04, 05, 06)
Todos vao ter os mesmos problemas que ja corrigimos:
- `$env` → hardcodar valores
- Falta header `Authorization: Bearer` no Supabase
- `genericCredentialType` → remover
- Falta node `Respond Error`
- Possivelmente `specifyBody: "string"` → trocar para `"json"`

Workflows pendentes:
- **01 - Get User Billing** — busca dados de billing do usuario
- **03 - Get Transactions** — lista transacoes de creditos
- **04 - Checkout Status** — verifica status de uma sessao de checkout
- **05 - Buy Credits** — compra de creditos avulsos
- **06 - Cancel Subscription** — cancela assinatura

### Prioridade 4: Conectar frontend ao billing
- Verificar `src/lib/api/billing.ts` — apontar para URLs corretas dos webhooks
- Configurar `VITE_N8N_WEBHOOK_URL=https://n8nwebhook.brainia.store/webhook`
- Testar fluxo completo pela interface (Settings > Planos > Assinar)

### Prioridade 5: Outras tarefas do pre-lancamento (10 de fev)
- Corrigir envio de detalhes do modelo para N8N
- Implementar tratamento de erro no frontend (nunca mostrar "workflow travou")
- Implementar travas de plano (limites de features e produtos)
- Criar 5 modelos padrao de qualidade
- Criar pagina de vendas
- Analisar vulnerabilidades

---

## Arquivos importantes

| Arquivo | Descricao |
|---|---|
| `GUIA_DO_COPILOTO.md` | Documento de memoria principal — regras, stack, decisoes, aprendizados N8N |
| `n8n-workflows/02-use-credits.json` | Workflow de debito de creditos (FUNCIONANDO) |
| `n8n-workflows/07-create-checkout.json` | Workflow de checkout Stripe (FUNCIONANDO, reimportar com URL corrigida) |
| `n8n-workflows/08-change-plan.json` | Workflow de mudanca de plano (CORRIGIDO, nao testado) |
| `n8n-workflows/09-stripe-webhook.json` | Webhook do Stripe (FUNCIONANDO) |
| `docs/proximos-passos.md` | Checklist geral do projeto (Fases 1-3) |

---

## Dica para retomar amanha

Ao iniciar nova sessao, pedir ao Claude:
1. Ler `GUIA_DO_COPILOTO.md` (memoria do projeto)
2. Ler `docs/sessao-2026-02-02.md` (este documento)
3. Continuar de onde paramos
