# Sessao 2026-02-07 — Resumo Completo

## O que foi feito

### 1. Fix: Angulo "folded" nao gerava
- **Problema**: O angulo dobrado usava `frontDbId` (imagem frontal GERADA) como referencia, mas essa imagem ainda nao existia no momento da geracao
- **Fix**: Mudado para `frontImageId` (foto ORIGINAL do produto enviada pelo usuario)
- **Arquivo**: `n8n-workflows/gerar-angulos-sequencial.js`

### 2. Fix: front_detail fallback
- **Problema**: `referenceImages['front']` era `undefined` porque o frontend envia a foto frontal separada (nao no mapa de referenceImages)
- **Fix**: Adicionado `frontImageId` como fallback: `referenceImages['front'] || frontImageId`
- **Arquivo**: `n8n-workflows/gerar-angulos-sequencial.js`

### 3. Bloqueio de back_detail no frontend
- **Problema**: Usuario podia tentar gerar detalhe de costas sem ter foto de costas
- **Fix**: back_detail agora bloqueado se nao ha foto de costas (back ou back_detail)
- **3 modos de modal**: blocked (sem costas), detail-tip (detalhe sem foto), warning (generico)
- **Arquivo**: `src/components/ProductStudio/ProductStudioEditor.tsx`

### 4. Otimizacao de memoria no N8N
- **Problema**: `studioImageBase64` (base64 da imagem) estava sendo incluido no JSON output do no "Gerar Foto Frontal", dobrando o consumo de memoria
- **Fix**: Removido do JSON output (a imagem ja esta disponivel como binary data)
- **Arquivo**: `n8n-workflows/code-nodes/gerar-foto-frontal.js`

### 5. Polling com timeout dinamico
- **Problema**: Timeout fixo de 5 minutos era insuficiente para muitos angulos
- **Fix**: `Math.max(10, numAngles * 2.5) * 60 * 1000` — escala com o numero de angulos
- **Arquivo**: `src/lib/api/studio.ts`

### 6. Fix tela de resultados
- **Problema**: Tela de resultados nao aparecia quando geracao era parcial (partial)
- **Fix**: `setShowResult(true)` quando ha imagens, seja completed ou partial
- **Arquivo**: `src/components/ProductStudio/ProductStudioEditor.tsx`

### 7. Prompts melhorados — CRITICAL SCALE WARNING
- Adicionado `CRITICAL SCALE WARNING` + `MACRO CLOSE-UP REQUIREMENTS` nos 3 prompts
- Gemini agora recebe instrucoes explicitas sobre escala e proporcao
- **Arquivos**: `gerar-foto-frontal.js`, `gerar-angulos-sequencial.js`, `gerar-foto-angulo.js`

### 8. Creditos por resolucao
- **2K = 1 credito/foto** | **4K = 2 creditos/foto**
- Novos campos no no "Extrair Dados": `creditCost` e `totalCredits`
- 5 nos atualizados: Tem Creditos?, Sem Creditos, Criar Geracao, Debitar Creditos, Responder Imediato
- `finalizar-geracao.js`: refund = `failedCount * creditCost`, credits_used = `successCount * creditCost`
- **Arquivos**: `n8n-workflows/production-raw.json`, `n8n-workflows/code-nodes/finalizar-geracao.js`

### 9. Anti-alucinacao para detalhe sem foto close-up
- **Problema**: Quando usuario gera front_detail ou back_detail sem foto de detalhe dedicada, o Gemini alucinava estampas completamente diferentes
- **Fix**: `noDetailRefBlock` adicionado nos prompts — instrui o Gemini a:
  1. OLHAR a foto original do produto
  2. IDENTIFICAR o elemento de detalhe real
  3. Fazer ZOOM nessa area exata
  4. PROIBICAO ABSOLUTA de inventar designs
- Temperatura reduzida: 0.4 → 0.3 em todos os prompts
- **Arquivos**: `gerar-angulos-sequencial.js`, `gerar-foto-angulo.js`

### 10. Angulos por categoria (5 por categoria)

| Categoria | Angulo 1 | Angulo 2 | Angulo 3 | Angulo 4 | Angulo 5 |
|-----------|----------|----------|----------|----------|----------|
| **Roupa** | Frente | Costas | Detalhe Frente | Detalhe Costas | Dobrada |
| **Calcado** | Frente | Par Traseira | Lateral | Par Superior | Sola |
| **Bone/Chapeu** | Frente | Traseira | Lateral | Vista Superior | Detalhe |
| **Bolsa/Mochila** | Frente | Traseira | Lateral | Interior | Detalhe |
| **Acessorio** | Frente | Costas | Lateral | Detalhe | Flat Lay |

### 11. Prompts especificos por categoria
- **Deteccao de categoria via regex**: `isFootwear`, `isHeadwear`, `isBag` usando padroes PT + EN
- **angleLabelsByCategory**: Descricoes detalhadas por angulo por categoria
  - Calcado: "SINGLE shoe at shoe-level, NOT from above", "PAIR of shoes, heels facing camera"
  - Bone: "front panel with logo facing camera", "brim and crown visible from above"
  - Bolsa: "standing upright, main front face", "interior compartments and lining visible"
- **presentationDescription por categoria**: shoe-level (calcado), upright (bolsa), flat-lay (acessorio)
- **Arquivos**: `gerar-foto-frontal.js`, `gerar-angulos-sequencial.js`, `gerar-foto-angulo.js`
- **Frontend**: `ANGLES_CONFIG` atualizado em `ProductStudioEditor.tsx`

### 12. Rebuild e Deploy
- Workflow N8N reconstruido: `n8n-workflows/15-product-studio-v91-sequential.json` (30 nos, 26 conexoes)
- Frontend compilado: TypeScript + Vite build OK
- Push feito: commit `bfab0ac`

---

## Commits desta sessao

```
bfab0ac feat: angulos e prompts especificos por categoria de produto
88febf5 fix: tela de resultados sempre aparece apos geracao (completed ou partial)
2f57a5f fix: aumentar timeout de polling para 10+ min (dinamico por numero de angulos)
33010a9 fix: bloqueio de angulos sem foto de costas + dica de detalhe no Product Studio
312ffd1 feat: front_detail e back_detail como angulos de geracao no Product Studio
```

---

## Arquivos modificados (N8N — gitignored, so local)

- `n8n-workflows/production-raw.json` — base com placeholders (creditCost, totalCredits, 5 nos atualizados)
- `n8n-workflows/code-nodes/gerar-foto-frontal.js` — prompt frontal com categorias + memoria otimizada
- `n8n-workflows/code-nodes/gerar-foto-angulo.js` — prompt angulo (sub-workflow) com categorias + noDetailRefBlock
- `n8n-workflows/code-nodes/finalizar-geracao.js` — creditos proporcionais a resolucao
- `n8n-workflows/gerar-angulos-sequencial.js` — orquestrador com categorias + noDetailRefBlock + temp 0.3
- `n8n-workflows/15-product-studio-v91-sequential.json` — workflow final pronto para importar

---

## O que falta fazer (proximo passo)

### URGENTE — Kaique precisa fazer:
1. **Reimportar o workflow** `n8n-workflows/15-product-studio-v91-sequential.json` no N8N
   - Substituir o workflow 14 atual pelo novo
   - O workflow ja tem TODAS as mudancas (creditos, categorias, anti-alucinacao, prompts)

2. **Testar por categoria**:
   - [ ] Tenis/calcado → verificar se frontal sai ao nivel do sapato (nao de cima)
   - [ ] Bone/chapeu → verificar perspectivas (frente com logo, superior com aba)
   - [ ] Bolsa/mochila → verificar interior e detalhe
   - [ ] Camiseta/roupa → confirmar que nada quebrou
   - [ ] Testar 2K vs 4K → confirmar creditos debitados corretamente

3. **Testar detalhe sem referencia**:
   - [ ] Gerar front_detail sem foto de detalhe → deve fazer zoom na foto frontal original (nao alucinar)

### PENDENTE — Proximas sessoes:
- [ ] Atualizar workflows N8N de importacao de produto (`vizzu/produto-importar` e `vizzu/produto-editar`) para aceitar `image_front_detail_base64` e `image_back_detail_base64`
- [ ] P1: Inpainting do logo na frontal (segunda passada no Gemini)
- [ ] P2: fetchWithRetry no frontend (timeout 60s + retry 3x + circuit breaker)

---

## Licoes aprendidas nesta sessao

1. **Referencia de angulo dobrado (folded) = foto ORIGINAL**, nao a gerada
2. **`referenceImages` do frontend NAO inclui 'front'** — front e enviado separado como `imageId`
3. **`studioImageBase64` no JSON output dobra memoria** — remover, ja esta disponivel como binary
4. **n8n `this.helpers.httpRequest` NAO suporta upload binario** — usar `this.helpers.request`
5. **Prompts longos PIORAM qualidade no Gemini** — frases curtas e estrategicas
6. **Categoria do produto muda TUDO no prompt** — mesma estrutura de workflow, prompts diferentes
7. **Nao precisa de workflows separados por categoria** — regex de deteccao + angleLabelMap resolve
